
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title></title>
    
    <meta name="author" content="Naizhengtan">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes//css/1.4.0/bootstrap.css" rel="stylesheet">
    <link href="/assets/themes//css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="/">Cheng TAN</a>
          <ul class="nav">
            
            
            


  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/blog">Blog</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/research/">Research</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/tech/">Tech</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        
<div class="page-header">
  <h1></h1>
</div>

<div class="row">
  <div class="span14">
    <p>This series of blogs are designed to explore the inner implementation and desgin of 
<a href="hhvm.com">hhvm</a>, a PHP interpreter developed by Facebook. There are a set of topics
should be covered, including:</p>

<ul>
  <li><a href="/2017/11/30/2015-7-15-inside-hhvm-value-system" title="value system">Value systems</a></li>
  <li><strong>Interpreter Architecture I: Main Loop</strong></li>
  <li>HHVM bytecode</li>
  <li>Jit</li>
</ul>

<p>HHVM is still in rapid developing, and the version I am working on is 3.6.0.
However, I believe the main design and implementation would remain the same.</p>

<h3 id="inside-hhvm-main-loop">Inside HHVM: Main Loop</h3>

<blockquote>
  <p>Program = Data Structures + Alogirthms</p>
</blockquote>

<p>In <a href="/2017/11/30/2015-7-15-inside-hhvm-value-system" title="value system">HHVM value system</a>, we know what data structures are used to store different types
of value. In this charpter, “algorithm” of the interpreter become our topic.
In short, HHVM simulates what CPU does. It fetches the current instruction, executes it, updates
the states and fetches the next instruction, so on and so forth. I personally call this
fetch-execute-fetch procedure the “<strong>Main Loop</strong>”.</p>

<h3 id="hiphop-bytecode">HipHop Bytecode</h3>

<p>Like CPU, HHVM has its own ISA which called HipHop Bytecode.
When HHVM tries to execute a PHP script, it first translates the PHP source code to
an intermediate representation which called HHBC (HipHop bytecode), then execute the bytecode
line by line. The HHBC is very much like Java bytecode. You can check the detailed 
design and its semantics <a href="https://github.com/facebook/hhvm/blob/master/hphp/doc/bytecode.specification" title="bytecode spec">here</a>.</p>

<blockquote>
  <p>HipHop bytecode (HHBC) v1 is intended to serve as the conceptual basis for
encoding the semantic meaning of HipHop source code into a format that is
appropriate for consumption by interpreters and just-in-time compilers. By
using simpler constructs to encode more complex expressions and statements,
HHBC makes it straightforward for an interpreter or a compiler to determine
the order of execution for a program.</p>
</blockquote>

<p>Let’s take the naivest “hello world” program as an example. Suppose we have a hello-world
PHP program:</p>

<pre><code>&lt;?php
  $a = "hello world";
  echo $a;
?&gt;
</code></pre>

<p>We can imagine this snippet of PHP code will be “compiled” to a series of HipHop bytecode:</p>

<pre><code>String "hello world"
SetL $a
PopC
CGetL $a
Print
PopC
Int 1
RetC
</code></pre>

<p>Each line of bytecode will be one instruction fetched and executed by HHVM interpreter.</p>

<h3 id="abstract-architecture-of-interpreter">Abstract Architecture of Interpreter</h3>

<p>The abstract architecture of interpreter is fairly simple.
It can be a big loop like:</p>

<pre><code>for(;;) {
	ins = fetch(); // fetch the new instrucction
	
	switch(ins) {  // jump to the right instruction
		case String: ...
		case SetL: ...
		case PopC: ...
		...
	}
}
</code></pre>

<p>The logic of “Main Loop” is just like described above.
Each time the interpreter fetches a instruction, it check what
the instruction is and jump to the corresponding instruction function.
After execution, it will do the fetching again until meet the EXIT instruction
or reach the end of the program. In the following paragraphs, I will use
instruction and bytecode interchangeably.</p>

<h3 id="hhvm-main-loop">HHVM Main Loop</h3>

<p>Sharing the same logic with our abstract architecure discribed in last section,
HHVM uses a different way to implement fetch-execute-fetch procedure. It adds
the “fetch and switch” operation to the end of each instruction function.
Instruction function is the function which implements what the bytecode,
say SetL/Popc, should do.</p>

<p>The pesudocode of the design is like:</p>

<pre><code>jumpTab[] = {
	iopString,
	iopSetL,
	iopPopC,
};

void fetchAndJump() {
	ins = fetch();
	jumpTab[ins]();
}

void iopString() {... fetchAndJump();}
void iopSetL()   {... fetchAndJump();}
void iopPopC()   {... fetchAndJump();}
</code></pre>

<p>When the interpreter finishes one instruction execution, say “SetL”, which should
be running “iopSetL()”, it will called “fetchAndJump()”. And the “fetchAndJump()”
will continue the program by jummping to the next instruction function.</p>

<p>In order to implement such design, we need to three components:</p>

<ul>
  <li>Jumping table</li>
  <li>Fetch and jump function</li>
  <li>Instruction functions</li>
</ul>

<h3 id="jumping-table">Jumping Table</h3>

<p>In order to implement the design, HHVM first define a function table which
contains all the instruction functions HHVM supports. HHVM uses the macro to
generate such table in <a href="https://github.com/facebook/hhvm/blob/master/hphp/runtime/vm/bytecode.cpp" title="main loop">runtime/vm/bytecode.cpp</a>:</p>

<pre><code>static const void *optabDirect[] = {
	#define O(name, imm, push, pop, flags) \
	&amp;&amp;Label##name,
	OPCODES
	#undef O
};
</code></pre>

<p>It will be little tricky to understand the code by first sight.
The “OPCODES” above is a macro declared in <a href="https://github.com/facebook/hhvm/blob/master/hphp/runtime/vm/hhbc.h" title="hhbc">runtime/vm/hhbc.h</a>:</p>

<pre><code>//  name             immediates        inputs           outputs     flags
 	#define OPCODES \
   ...
   O(PopC,            NA,               ONE(CV),         NOV,        NF) \
   ...
   O(String,          ONE(SA),          NOV,             ONE(CV),    NF) \
   ...
   O(SetL,            ONE(LA),          ONE(CV),         ONE(CV),    NF) \
   ...
</code></pre>

<p>As you can see, after the preprocessor, 
the the “opttabDirect” will be expanded as:</p>

<pre><code>static const void *optabDirect[] = {
	...
	&amp;&amp;LabelPopC,
	...
	&amp;&amp;LabelString,
	...
	&amp;&amp;LabelSetL,
	...
</code></pre>

<p>With this table, HHVM can use <code>goto *optab[uint8_t(op)]</code> (“op” is the instruction
number) jumping to the instruction function very efficiently.</p>

<h3 id="fetch-and-jump-function">Fetch and Jump Function</h3>

<p>The “fetch and jump” function is also a macro in HHVM called “DISPATCH”. This
is the simplified version. If you want to see the original one please check
<a href="https://github.com/facebook/hhvm/blob/master/hphp/runtime/vm/bytecode.cpp" title="main loop">runtime/vm/bytecode.cpp</a>.</p>

<pre><code>#define DISPATCH() do {                      \
	Op op = *reinterpret_cast&lt;const Op*&gt;(pc); \
	goto *optab[uint8_t(op)];                 \
} while(0)
</code></pre>

<h3 id="instruction-functions">Instruction Functions</h3>

<p>The real implementation of each instruction is defined in the 
corresponding function named “iop<bytecode-name>". For example,
for instruction/bytecode "PopC", the corresponding function is
"iopPopC".</bytecode-name></p>

<p>However, if you read the section <a href="#jumping-table">Jumping Table</a> really carefully,
you will find that the jumping table contains a series of labels rather
than function pointers. HHVM needs somehow adding the labels to the
corresponding instruction functions. Here is the snippet of code
to do such work. Still they are macro. There are several good reasons
to use “lable + macro” rather than “function pointer” table.</p>

<pre><code>#define O(name, imm, push, pop, flags)  \
	Label##name: {                       \
		iop##name(pc);                    \
		vmpc() = pc;                      \
		DISPATCH();                       \
	}
	OPCODES
</code></pre>

<p>As usual, this is a simplified version, you can check the full version
<a href="https://github.com/facebook/hhvm/blob/master/hphp/runtime/vm/bytecode.cpp" title="main loop">here</a>. To recall, “OPCODES” is a macro we mentioned in section 
<a href="#jumping-table">Jumping Table</a>; macro “DISPATCH” is a macro we mentioned 
in section <a href="#fetch-and-jump-function">Fetch and Jump Function</a>.
This macro will build a series of labels each of which will (1) call
instruction function (2) call fetch-and-jump function.</p>

<h3 id="summary">Summary</h3>

<p>To conclude, we have discussed the main logic of the interpreter and given a
detail analysis on the implementaion of HHVM’s “Main Loop”.</p>


  </div>
</div>


      </div>

      <footer>
        <p>&copy; Naizhengtan 2014 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
  </body>
</html>

